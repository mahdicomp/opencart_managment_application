<modification>
<name>api-opencart-ir.com</name>
<code>api-opencart-ir.com</code>
<version>2.x-3.x</version>
<author>opencart-ir.com</author>
<link>opencart-ir.com</link>
 <file path="admin/controller/common/column_left.php" >
	<operation>
		<search ><![CDATA[
  		        	$marketplace = array();
            ]]></search>
		<add position="before" ><![CDATA[
			$storeapp = array();

			if ($this->user->hasPermission('access', 'extension/module/storeapp')) {
				$storeapp[] = array(
					'name'	   => $this->language->get('text_storeapp_setting'),
					'href'     => $this->url->link('extension/module/storeapp', 'user_token=' . $this->session->data['user_token'], true),
					'children' => array()		
				);	
			}
			if ($this->user->hasPermission('access', 'extension/module/storeapp')) {
				$storeapp[] = array(
					'name'	   => $this->language->get('text_storeapp_notification'),
					'href'     => $this->url->link('extension/module/storeapp/notification', 'user_token=' . $this->session->data['user_token'], true),
					'children' => array()		
				);	
			}
			if ($this->user->hasPermission('access', 'extension/module/storeapp')) {
				$storeapp[] = array(
					'name'	   => $this->language->get('text_storeapp_list'),
					'href'     => $this->url->link('extension/module/storeapp/list_phone', 'user_token=' . $this->session->data['user_token'], true),
					'children' => array()		
				);	
			}
			
			
			if ($storeapp) {
				$data['menus'][] = array(
					'id'       => 'menu-storeapp',
					'icon'	   => 'fa-mobile', 
					'name'	   => $this->language->get('text_storeapp'),
					'href'     => '',
					'children' => $storeapp
				);		
			}
			
			
            ]]></add>
</operation>
</file>
 <file path="admin/language/en-gb/common/column_left.php" >
	<operation>
		<search ><![CDATA[
  		        // Text
            ]]></search>
		<add position="after" ><![CDATA[
			$_['text_storeapp_setting']          = 'application setting';
			$_['text_storeapp']                  = 'application management';
			$_['text_storeapp_list']             = 'List of devices used by the app';
			$_['text_storeapp_notification']     = 'Application message list';
			
            ]]></add>
</operation>
</file>
 <file path="admin/language/fa-ir/common/column_left.php" >
	<operation>
		<search ><![CDATA[
  		        // Text
            ]]></search>
		<add position="after" ><![CDATA[
			$_['text_storeapp_setting']                  = 'تنظیمات اپلیکشن';
			$_['text_storeapp']                  = 'مدیریت اپلیکشن';
			$_['text_storeapp_list']                  = 'لیست دستگاه های مورد استفاده از اپلیکشن';
			$_['text_storeapp_notification']                  = 'لیست پیام های اپلیکشن';
			
            ]]></add>
</operation>
</file>
 <file path="catalog/language/en-gb/account/register.php" >
	<operation>
		<search ><![CDATA[
  		       // Error		
            ]]></search>
		<add position="after" ><![CDATA[
			$_['error_exists_phonenumber']          = 'Warning: Telephone is already registered!';
			
            ]]></add>
</operation>
</file>
 <file path="catalog/language/fa-ir/account/register.php" >
	<operation>
		<search ><![CDATA[
  		       // Error		
            ]]></search>
		<add position="after" ><![CDATA[
			$_['error_exists_phonenumber']                  = 'شماره تلفن تکراری است';
			
            ]]></add>
</operation>
</file>

 <file path="catalog/language/en-gb/account/edit.php" >
	<operation>
		<search ><![CDATA[
  		       // Error		
            ]]></search>
		<add position="after" ><![CDATA[
			$_['error_exists_phonenumber']          = 'Warning: Telephone is already registered!';
			
            ]]></add>
</operation>
</file>
 <file path="catalog/language/fa-ir/account/edit.php" >
	<operation>
		<search ><![CDATA[
  		       // Error		
            ]]></search>
		<add position="after" ><![CDATA[
			$_['error_exists_phonenumber']                  = 'شماره تلفن تکراری است';
			
            ]]></add>
</operation>
</file>
 <file path="catalog/language/en-gb/account/password.php" >
	<operation>
		<search ><![CDATA[
  		       // Error		
            ]]></search>
		<add position="after" ><![CDATA[
			$_['error_old_password']          = 'Warning: old password Is wrong !';
			
            ]]></add>
</operation>
</file>
 <file path="catalog/language/fa-ir/account/password.php" >
	<operation>
		<search ><![CDATA[
  		       // Error		
            ]]></search>
		<add position="after" ><![CDATA[
			$_['error_old_password']                  = 'پسورد قدیم اشتباه است';
			
            ]]></add>
</operation>
</file>
 <file path="system/library/cart/cart.php" >
	<operation>
		<search ><![CDATA[
   public function hasProducts() {
            ]]></search>
		<add position="before" ><![CDATA[
    public function countNumProducts() {
		$product_total = 0;

		$products = $this->getProducts();

		foreach ($products as $product) {
			$product_total ++;
		}

		return $product_total;
	}
	
	public function getSession() {
	    
		$cart_query = $this->db->query("SELECT session_id FROM " . DB_PREFIX . "cart WHERE  customer_id = '" . (int)$this->customer->getId() . "'");
		if ($cart_query->num_rows) {
		   // echo $this->customer->getId();
					$session_id = $cart_query->row['session_id'];
		} else {
				$session_id = 	$this->session->start(); 
			}
				
				return $session_id;
	}

		    ]]></add>
</operation>
</file>
 <file path="system/library/cart/customer.php" >
	<operation>
		<search  index="1" ><![CDATA[
   	if ($customer_query->num_rows) {
            ]]></search>
		<add position="before" ><![CDATA[
    if (!$customer_query->num_rows) {
		     if ($override) {
			$customer_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "customer WHERE telephone = '" . $this->db->escape($email) . "' AND status = '1'");
		} else {
			$customer_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "customer WHERE telephone = '" . $this->db->escape($email) . "'  AND (password = SHA1(CONCAT(salt, SHA1(CONCAT(salt, SHA1('" . $this->db->escape($password) . "'))))) OR password = '" . $this->db->escape(md5($password)) . "') AND status = '1'");
		}

		}
		    ]]></add>
</operation>
	<operation>
		<search ><![CDATA[
   	      public function logout() {
            ]]></search>
		<add position="before" ><![CDATA[
    public function loginWithId($customer_id) {
	
			$customer_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "customer WHERE customer_id = '" . (int)$customer_id . "' AND status = '1'");
		

		if ($customer_query->num_rows) {
			$this->session->data['customer_id'] = $customer_query->row['customer_id'];

			$this->customer_id = $customer_query->row['customer_id'];
			$this->firstname = $customer_query->row['firstname'];
			$this->lastname = $customer_query->row['lastname'];
			$this->customer_group_id = $customer_query->row['customer_group_id'];
			$this->email = $customer_query->row['email'];
			$this->telephone = $customer_query->row['telephone'];
			$this->newsletter = $customer_query->row['newsletter'];
			$this->address_id = $customer_query->row['address_id'];
		
			$this->db->query("UPDATE " . DB_PREFIX . "customer SET language_id = '" . (int)$this->config->get('config_language_id') . "', ip = '" . $this->db->escape($this->request->server['REMOTE_ADDR']) . "' WHERE customer_id = '" . (int)$this->customer_id . "'");

			return true;
		} else {
			return false;
		}
	}
		    ]]></add>
</operation>
</file>
 <file path="catalog/model/catalog/product.php" >
	<operation>
			<search ><![CDATA[
				if (!empty($data['filter_manufacturer_id'])) {
				]]></search>
			<add position="before" ><![CDATA[
				if (!empty($data['filter_quantity'])) {
				$sql .= " AND p.quantity > 0";
			}
				]]></add>
   	</operation>
   
   <operation>
			<search><![CDATA[
				public function getProduct($product_id) {
			]]></search>
			<add position="before"><![CDATA[
			
			public function getProductSpecialDates($product_id)
			{
				
					if ($this->customer->isLogged()) {
						$customer_group_id = $this->customer->getCustomerGroupId();
					} else {
						$customer_group_id = $this->config->get('config_customer_group_id');
					}   

					$query = $this->db->query("SELECT date_start, date_end  FROM " . DB_PREFIX . "product_special WHERE product_id = '" . (int)$product_id . "' AND customer_group_id = '" . (int)$customer_group_id . "'  ORDER BY priority ASC, price ASC LIMIT 1");

				return $query->row;			
			}
			
			]]></add>
		</operation>
</file>
  
  <file path="catalog/model/account/wishlist.php" >
	<operation>
		<search ><![CDATA[
			public function getWishlist() {
			]]></search>
		<add position="before" ><![CDATA[
		public function getWishlistByproductId($product_id) {
        $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "customer_wishlist WHERE customer_id = '" . (int)$this->customer->getId() . "'  AND product_id = '" . (int)$product_id . "'");
        if ($query->num_rows) {
			return true;
		}else {
            return false;
		}
		
	}
			]]></add>
</operation>
</file>
 <file path="system/startup.php" >
	<operation>
		<search ><![CDATA[require_once(DIR_SYSTEM . 'helper/utf8.php'); ]]></search>
		<add position="after" ><![CDATA[require_once(DIR_SYSTEM . 'library/fcm/fcm.php');]]></add>
</operation>
</file>
 <file path="catalog/model/account/customer.php" >
	<operation>
		<search ><![CDATA[
				$this->db->query("UPDATE " . DB_PREFIX . "customer SET salt = '" . $this->db->escape($salt = token(9)) . "', password = '" . $this->db->escape(sha1($salt . sha1($salt . sha1($password)))) . "', code = '' WHERE LOWER(email) = '" . $this->db->escape(utf8_strtolower($email)) . "'");
	
			]]></search>
		<add position="replace" ><![CDATA[
			$this->db->query("UPDATE " . DB_PREFIX . "customer SET salt = '" . $this->db->escape($salt = token(9)) . "', password = '" . $this->db->escape(sha1($salt . sha1($salt . sha1($password)))) . "', code = '' WHERE LOWER(email) = '" . $this->db->escape(utf8_strtolower($email)) . "' OR telephone = '" . $this->db->escape($email) . "'");
	
			]]></add>
</operation>
	<operation>
		<search ><![CDATA[
          
          $this->db->query("UPDATE `" . DB_PREFIX . "customer` SET code = '" . $this->db->escape($code) . "' WHERE LCASE(email) = '" . $this->db->escape(utf8_strtolower($email)) . "'");
          ]]></search>
		<add position="replace" ><![CDATA[
          $this->db->query("UPDATE `" . DB_PREFIX . "customer` SET code = '" . $this->db->escape($code) . "' WHERE LCASE(email) = '" . $this->db->escape(utf8_strtolower($email)) . "' OR telephone = '" . $this->db->escape($email) . "'");
          
      
          ]]></add>
</operation>
	<operation>
		<search ><![CDATA[
				public function editPassword($email, $password) {
			]]></search>
		<add position="before" ><![CDATA[
				public function checkPassword($customer_id,$password) {
		$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "customer WHERE customer_id = '" . (int)$customer_id . "' AND (password = SHA1(CONCAT(salt, SHA1(CONCAT(salt, SHA1('" . $this->db->escape($password) . "'))))) OR password = '" . $this->db->escape(md5($password)) . "')");

		return $query->row;
		}
			]]></add>
</operation>
	<operation>
		<search ><![CDATA[
   	    	$query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "customer WHERE LOWER(email) = '" . $this->db->escape(utf8_strtolower($email)) . "'");

            ]]></search>
		<add position="replace" ><![CDATA[
         $query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "customer WHERE LOWER(email) = '" . $this->db->escape(utf8_strtolower($email)) . "' OR telephone = '" . $this->db->escape($email) . "'");

		    ]]></add>
</operation>
	<operation>
		<search ><![CDATA[
   	    	$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "customer WHERE LOWER(email) = '" . $this->db->escape(utf8_strtolower($email)) . "'");

            ]]></search>
		<add position="replace" ><![CDATA[
         $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "customer WHERE LOWER(email) = '" . $this->db->escape(utf8_strtolower($email)) . "' OR telephone = '" . $this->db->escape($email) . "'");

		    ]]></add>
</operation>
</file>
</modification>
